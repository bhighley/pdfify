#!/bin/sh
# Usage: script/pdfify /path/to/markdown/file.md
# creates octocat-friendly PDF from Markdown
#

# Exit immediately if a command exits with a non-zero status.
set -e

STYLE="style.css"
[ "$1" = "--student" -o "$1" = "-s" ] && {
    STYLE="student.css"
    shift
}

BASE_DIR="$(brew --prefix)/opt/pdfify/lib"
[ -d "$HOME/.pdfify" ] && {
    BASE_DIR="$HOME/.pdfify"
}

TMP=$( mktemp -d )
TARGET="$(basename -s md "${1:-pdfify.}")"
TARGET_DIR="$(dirname "${1:-.}")"

# Read from stdin, if filename not passed as first argument
pandoc < "${1:-/dev/stdin}" \
    -f markdown_github+header_attributes \
    -t html5 \
    -B "${BASE_DIR}/header.html" \
    -A "${BASE_DIR}/footer.html" \
    -o "${TMP}/${TARGET}html"

echo "${TMP}/${TARGET}html"

wkhtmltopdf \
    --page-size letter \
    --no-pdf-compression \
    --margin-top 15 \
    --margin-left 15 \
    --footer-right '[page]/[toPage]' \
    --footer-font-name 'Source Sans Pro' \
    --footer-line \
    --print-media-type \
    --user-style-sheet "${BASE_DIR}/${STYLE}" \
    "${TMP}/${TARGET}html" "${TARGET_DIR}/${TARGET}pdf"
